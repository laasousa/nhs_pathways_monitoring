---
title: "Covid-19 trends in England"
description: |
  Using ASMODEE to monitor NHS pathways in England
author:
  - name: Thibaut Jombart, Dirk Schumacher, Tim Taylor
date: "`r Sys.Date() - 1`"
output: distill::distill_article
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, results = "hide", fig.height = 5, fig.width = 8, dpi = 80, layout="l-body-outset")
```

## Methodology

Using the new algorithm ASMODEE (**A**utomatic **S**election of **M**odels and
**O**utlier **D**etection for **E**pidemics) we monitor changes in potential
COVID-19 cases reported through the [NHS
pathways](https://digital.nhs.uk/dashboards/nhs-pathways), including calls to
111, 999, and 111-online. Only the last 6 weeks of data are used.

**Note**: this research has not been peer-reviewed yet. This website is still
experimental. Please contact the <a
href="mailto:thibautjombart@gmail.com">authors</a> before using its content.


Models considered here for trend fitting include:

* Gaussian GLM and Negative Binomial GLMs
* With the following effects
    + constant, linear, or log-linear time effect
    + optional: weekend effect (weekend / monday / other
      day, or weekday effect
	  )
    + optional: with a change in slope at a given day, from day 9 to day 25
	
Analyses are run separately for each NHS region.

```{r packages}
library(incidence2)
library(trendbreaker)
library(ggplot2)
library(cowplot)
library(dplyr)
library(i2extras)
library(mapview)
library(sf)
```



```{r prep}
# get the latest data
folder <- file.path("data", "clean")
filenames <- sort(list.files(folder), decreasing = TRUE)
pathways <- readRDS(file.path(folder, filenames[1]))

# tidy up names
pathways$ccg_name <- sub("_ccg$", "", pathways$ccg_name)
first_date <- max(pathways$date, na.rm = TRUE) - 7*7
pathways_recent <- pathways[pathways$date >= first_date, ]

# function to assign custom day of the week to dates
day_of_week <- function(date) {
  day_of_week <- weekdays(date)
  out <- vapply(
    day_of_week,
    function(x) {
      if (x %in% c("Saturday", "Sunday")) {
        "Weekend"
      } else if (x == "Monday") {
        "Monday"
      } else {
        "rest_of_week"
      }
    },
    character(1)
  )
  factor(out, levels = c("rest_of_week", "Monday", "Weekend"))
}

```


```{r }

# generate counts for all data
counts_england <- incidence(
  pathways_recent,
  date_index = date,
  count = count
)

# add on day and weekday
counts_england <- counts_england %>%
  mutate(day_type = day_of_week(date_index),
         weekday = weekdays(date_index),
         day = as.integer(date_index - min(date_index)))

min_k <- 9
max_k <- 25
k_values <- min_k:max_k
change_k_df <- lapply(k_values,
                       function(k)
                         counts_england %>%
                         transmute(if_else(day <= k, "before", "after")) %>%
                         pull(1)) %>%
  data.frame() %>%
  tibble() %>%
  setNames(paste0("change_", k_values))

counts_england <- counts_england %>%
  bind_cols(change_k_df)

```




```{r }

model_grid <- expand.grid(
    "date_index", # time effect
    c("", "day_type", "weekday"), # optional offsets for specific days
    c("", paste("date_index*change", k_values, sep = "_")) # optional split
)

## convert to text
predictors_txt <- model_grid %>%
  apply(1, paste, collapse = " + ")

## cleanup
predictors_txt <- gsub("(\\+[ ]*)+[ ]*\\+", " + ", predictors_txt) # +... + -> +
predictors_txt <- sub("^[ ]*\\+", "", predictors_txt) # heading +
predictors_txt <- sub("\\+[ ]*$", "", predictors_txt) # trailing +
predictors_txt <- sub("^[ ]+", "", predictors_txt) # heading spaces
predictors_txt <- sub("[ ]+$", "", predictors_txt) # trailing spaces
predictors_txt <- sub("[ ]+", " ", predictors_txt) # multiple spaces

## add constant models
predictors_txt <- c("1", predictors_txt)



models_txt  <- c(
    ## sprintf("lm_model(cases ~ %s)", predictors_txt), # linear models
    sprintf("glm_model(count ~ %s, family = 'gaussian')", predictors_txt), # Gaussian GLMs
    sprintf("glm_nb_model(count ~ %s)", predictors_txt) # NegBin GLMs
)

length(models_txt)
head(models_txt)
tail(models_txt)

models <- lapply(models_txt, function(e) eval(parse(text = e)))


## # define candidate models
## models <- list(
##   regression = lm_model(count ~ date_index),
##   poisson_constant = glm_model(count ~ 1, family = "poisson"),
##   poisson_time = glm_model(count ~ date_index, family = "poisson"),
##   poisson_time_daytype = glm_model(count ~ day_type + date_index, family = "poisson"),
##   poisson_time_weekday = glm_model(count ~ weekday + date_index, family = "poisson"),
##   negbin_constant = glm_nb_model(count ~ 1),
##   negbin_time = glm_nb_model(count ~ date_index),
##   negbin_time_daytype = glm_nb_model(count ~ day_type + date_index),
##   negbin_time_weekday = glm_nb_model(count ~ weekday + date_index)
## )


```





## ASMODEE results

### England

```{r }

## results with 'k' fixed to 7 days
res_england <- asmodee(
  counts_england,
  models,
  method = evaluate_aic,
  alpha = 0.05,
  fixed_k = 7
)

plot(res_england) +
  theme(text = element_text(size = 16),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_date(date_label = format("%d %b")) +
  labs(x = NULL,
       y = "Daily, potential, COVID-19 reports")

```

``` {r}
# identify doubling/halving time across england
rate_england <- counts_england %>% 
  keep_last(7 * 4) %>% 
  fit_curve("negbin") %>% 
  growth_rate() %>%
  cbind("nhs_region" = "England")

# function to describe change in epidemic growth
growth_descriptive <- function(rate_region){
  describe <- ifelse(rate_region$time >= 50, paste0("effectively unchanging with a ", rate_region$growth_or_decay,
                                                    " time greater than 50 days ", "(rate = ", round(rate_region$r, 3), ")."),
                     ifelse(rate_region$growth_or_decay == "doubling" & rate_region$time < 50,
                            paste0("growing. At current rates the number of daily cases in ",
                                   rate_region$nhs_region,
                                   " will be double todays in ",
                                   ifelse(rate_region$time > 50, "more than 50", round(rate_region$time, 0)),
                                   " days (rate = ", round(rate_region$r, 3), ")."),
                            ifelse(rate_region$growth_or_decay == "halving" & rate_region$time < 50,
                                   paste0("falling. At current rates the number of daily cases in ",
                                          rate_region$nhs_region,
                                          " will be half of todays in ",
                                          ifelse(rate_region$time > 50, "more than 50", round(rate_region$time, 0)),
                                          " days (rate = ", round(rate_region$r, 3), ")."),
                                   "ERROR")))
}

change_england <- growth_descriptive(rate_england)
```

The number of reports via 111/999 suggest the COVID-19 epidemic in England is currently `r paste(change_england)`

### NHS regions

```{r results_nhs_region, fig.height = 7}

# generate for regions
counts_nhs_region <- incidence(
  pathways_recent,
  date_index = date,
  groups = nhs_region,
  count = count,
  na_as_group = FALSE
)

# add on day and weekday
counts_nhs_region <- counts_nhs_region %>%
  mutate(day_type = day_of_week(date_index),
         weekday = weekdays(date_index),
         day = as.integer(date_index - min(date_index)))

# add changepoints
change_k_df <- lapply(k_values,
                      function(k)
                        counts_nhs_region %>%
                          transmute(if_else(day <= k, "before", "after")) %>%
                          pull(1)) %>%
  data.frame() %>%
  tibble() %>%
  setNames(paste0("change_", k_values))

counts_nhs_region <- counts_nhs_region %>%
  bind_cols(change_k_df)


res_nhs_region <- asmodee(
  counts_nhs_region,
  models,
  method = evaluate_aic,
  alpha = 0.05,
  fixed_k = 7
)

#plot(res_nhs_region)

# calculate the halving/doubline rate across NHS regions
rate_nhs_region <- counts_nhs_region %>% 
  keep_last(7 * 4) %>% 
  fit_curve("negbin") %>% 
  growth_rate()

change_eoe <- growth_descriptive(rate_nhs_region %>%
                                  filter(nhs_region == "East of England"))
change_london <- growth_descriptive(rate_nhs_region %>%
                                  filter(nhs_region == "London"))
change_midlands <- growth_descriptive(rate_nhs_region %>%
                                  filter(nhs_region == "Midlands"))
change_ney <- growth_descriptive(rate_nhs_region %>%
                                  filter(nhs_region == "North East and Yorkshire"))
change_nw <- growth_descriptive(rate_nhs_region %>%
                                  filter(nhs_region == "North West"))
change_se <- growth_descriptive(rate_nhs_region %>%
                                  filter(nhs_region == "South East"))
change_sw <- growth_descriptive(rate_nhs_region %>%
                                  filter(nhs_region == "South West"))
```

The number of local reports to 111/999 suggest the following changes in the rate of growth of the COVID-19 epidemic:

  + East of England is `r paste(change_eoe)`
  + London is  `r paste(change_london)`
  + Midlands region is  `r paste(change_midlands)`
  + North East and Yorkshire region is  `r paste(change_ney)`
  + North West region is  `r paste(change_nw)`
  + South East region is  `r paste(change_se)`
  + South West region is  `r paste(change_sw)`

### Map of case growth/decay in NHS regions

Selecting the region will display the ASMODEE prediction plot

``` {r prepare_plot, echo =F}
region_shape <- st_read(file.path("data", "shapefile", "nhs_region_2019.shp")) 

region_plots <- lapply(res_nhs_region, plot, guide = F)

growth_levels <- c("Halving" = "halving", "Minimal change" = "minimal change", "Doubling" = "doubling")

regions <- region_shape %>%
  full_join(., rate_nhs_region %>%
              rename("nhser19nm" = "nhs_region") %>%
              dplyr::select(nhser19nm, growth_or_decay, time),
            by = "nhser19nm") %>%
  mutate(growth = factor(ifelse(time >= 50, "minimal change", growth_or_decay), levels = c("halving", "minimal change", "doubling"), labels = names(growth_levels)),
         growth = recode_factor(growth, !!!growth_levels),
         time = ifelse(time > 50, ">50 days", paste0(round(time, 0), " days")),
         plots = region_plots[nhser19nm],
         label = paste0(nhser19nm, ", ", growth_or_decay, " time = ", time)) %>%
  rename("NHS region" = "nhser19nm",
         `Case growth/decay` = "growth") # tidying the column titles for mapview

plots <- regions$plots

mapviewOptions(leafletHeight = 620,
               basemaps = c("CartoDB.Positron"))

mapview(regions, 
       zcol = "Case growth/decay", 
       legend = T,
       alpha.regions = 1,
       lwd = 1.5,
       label = "label",
       popup = popupGraph(plots,
                          width = 260,
                          height = 180))
```


## Analyses by age groups

This section reproduces the same analyses as above, broken down by age groups.

### All of England

```{r }

# generate for regions
counts_england_age <- pathways_recent %>%
  mutate(age = if_else(age == "70-120", "70+", age)) %>%
  incidence(
      date_index = date,
      groups = age,
      count = count,
      na_as_group = FALSE
  )

# add on day and weekday
counts_england_age <- counts_england_age %>%
  mutate(day_type = day_of_week(date_index),
         weekday = weekdays(date_index),
         day = as.integer(date_index - min(date_index)))

# add changepoints
change_k_df <- lapply(k_values,
                      function(k)
                        counts_england_age %>%
                          transmute(if_else(day <= k, "before", "after")) %>%
                          pull(1)) %>%
  data.frame() %>%
  tibble() %>%
  setNames(paste0("change_", k_values))

counts_england_age <- counts_england_age %>%
  bind_cols(change_k_df)

# run asmodee
res_england_age <- asmodee(
  counts_england_age,
  models,
  method = evaluate_aic,
  alpha = 0.05,
  fixed_k = 7
)

```

```{r echo = FALSE}

n_figs <- length(res_england_age)

```

```{r fig.height = 2 * round(n_figs / 3), out.width = "100%", dpi = 70} 

res_england_age <- res_england_age[sort(names(res_england_age))]
plot(res_england_age, ncol = 3)

```


### NHS regions

```{r }

# generate for regions
counts_nhs_region_age <- pathways_recent %>%
  mutate(age = if_else(age == "70-120", "70+", age)) %>%
  incidence(
      date_index = date,
      groups = c(nhs_region, age),
      count = count,
      na_as_group = FALSE
  )

# add on day and weekday
counts_nhs_region_age <- counts_nhs_region_age %>%
  mutate(day_type = day_of_week(date_index),
         weekday = weekdays(date_index),
         day = as.integer(date_index - min(date_index)))

# add changepoints
change_k_df <- lapply(k_values,
                      function(k)
                        counts_nhs_region_age %>%
                          transmute(if_else(day <= k, "before", "after")) %>%
                          pull(1)) %>%
  data.frame() %>%
  tibble() %>%
  setNames(paste0("change_", k_values))

counts_nhs_region_age <- counts_nhs_region_age %>%
  bind_cols(change_k_df)


# run asmodee
res_nhs_region_age <- asmodee(
  counts_nhs_region_age,
  models,
  method = evaluate_aic,
  alpha = 0.05,
  fixed_k = 7
)

```

```{r echo = FALSE}

n_figs <- length(res_nhs_region_age)

```

```{r fig.height = 2 * round(n_figs / 3), out.width = "100%", dpi = 70} 

res_nhs_region_age <- res_nhs_region_age[sort(names(res_nhs_region_age))]
plot(res_nhs_region_age, ncol = 3)

```


