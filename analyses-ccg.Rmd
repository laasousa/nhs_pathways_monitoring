---
title: "Covid-19 trends by CCG level"
description: |
  Using ASMODEE to monitor NHS pathways by CCG
author:
  - name: Thibaut Jombart, David Simons, Dirk Schumacher, Tim Taylor
date: "`r Sys.Date() - 1`"
output: distill::distill_article
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, results = "hide", fig.height = 5, fig.width = 8, dpi = 80)
```

Using the new algorithm ASMODEE (**A**utomatic **S**election of **M**odels and
**O**utlier **D**etection for **E**pidemics) we monitor changes in potential
COVID-19 cases reported through the [NHS
pathways](https://digital.nhs.uk/dashboards/nhs-pathways), including calls to
111, 999, and 111-online. These analyses are broken down by Clinical
Commissioning Groups [(CCG)](https://www.england.nhs.uk/ccgs/). Only the last 6
weeks of data are used. The last week of data is not used to define the temporal
trend so that recent outliers can be detected.

**Note**: this research has not been peer-reviewed yet. This website is still
experimental. Please contact the <a
href="mailto:thibautjombart@gmail.com">authors</a> before using its content.


* Gaussian GLM and Negative Binomial GLMs
* With the following effects
    + constant, linear, or log-linear time effect
    + optional: weekend effect (weekend / monday / other
      day, or weekday effect
	  )
    + optional: with a change in slope at a given day, from day 9 to day 25
	
Analyses are run separately for each CCG.

```{r packages}
library(incidence2)
library(i2extras)
library(trendbreaker)
library(ggplot2)
library(cowplot)
library(DT)
library(dplyr)
library(tibble)
library(tidyr)
library(sf)
library(mapview)
library(leafpop)
```

```{r prep}
# get the latest data
folder <- file.path("data", "clean")
filenames <- sort(list.files(folder), decreasing = TRUE)
pathways <- readRDS(file.path(folder, filenames[1]))

# tidy up names
pathways$ccg_name <- sub("_ccg$", "", pathways$ccg_name)
first_date <- max(pathways$date, na.rm = TRUE) - 7 * 7
pathways_recent <- pathways[pathways$date >= first_date, ]

# function to assign custom day of the week to dates
day_of_week <- function(date) {
  day_of_week <- weekdays(date)
  out <- vapply(
    day_of_week,
    function(x) {
      if (x %in% c("Saturday", "Sunday")) {
        "Weekend"
      } else if (x == "Monday") {
        "Monday"
      } else {
        "rest_of_week"
      }
    },
    character(1)
  )
  factor(out, levels = c("rest_of_week", "Monday", "Weekend"))
}

# function to convert character string to snake_case
to_snake_case <- function(x) {
  tmp <- gsub(",", "", x)
  tolower(gsub("\\s+", "_", tmp))
}
``` 




```{r }

# get count by CCG
counts_ccg_all <- incidence(
  pathways_recent,
  date_index = date,
  count = count,
  groups = ccg_name
)

# add on day and weekday
counts_ccg_all <- counts_ccg_all %>%
  mutate(day_type = day_of_week(date_index),
         weekday = weekdays(date_index),
         day = as.integer(date_index - min(date_index)))

min_k <- 9
max_k <- 25
k_values <- min_k:max_k
change_k_df <- lapply(k_values,
                       function(k)
                         counts_ccg_all %>%
                         transmute(if_else(day <= k, "before", "after")) %>%
                         pull(1)) %>%
  data.frame() %>%
  tibble() %>%
  setNames(paste0("change_", k_values))

counts_ccg_all <- counts_ccg_all %>%
  bind_cols(change_k_df)


# generate models
model_grid <- expand.grid(
    "date_index", # time effect
    c("", "day_type", "weekday"), # optional offsets for specific days
    c("", paste("date_index*change", k_values, sep = "_")) # optional split
)

## convert to text
predictors_txt <- model_grid %>%
  apply(1, paste, collapse = " + ")

## cleanup
predictors_txt <- gsub("(\\+[ ]*)+[ ]*\\+", " + ", predictors_txt) # +... + -> +
predictors_txt <- sub("^[ ]*\\+", "", predictors_txt) # heading +
predictors_txt <- sub("\\+[ ]*$", "", predictors_txt) # trailing +
predictors_txt <- sub("^[ ]+", "", predictors_txt) # heading spaces
predictors_txt <- sub("[ ]+$", "", predictors_txt) # trailing spaces
predictors_txt <- sub("[ ]+", " ", predictors_txt) # multiple spaces

## add constant models
predictors_txt <- c("1", predictors_txt)



models_txt  <- c(
    sprintf("glm_model(count ~ %s, family = 'gaussian')", predictors_txt), # Gaussian GLMs
    sprintf("glm_nb_model(count ~ %s)", predictors_txt) # NegBin GLMs
)

length(models_txt)
head(models_txt)
tail(models_txt)

models <- lapply(models_txt, function(e) eval(parse(text = e)))

```






## Results: 111/999 calls and 111-online.

These analyses use calls to 111 and 999, as well as NHS 111-online reports of
potential COVID-19 cases.

```{r results_ccg_calls}

## run asmodee on all CCGs
## note: this takes about 1 minute to run with AIC model selection,
## around 16-17 min with cross validation
res_ccg_all <- asmodee(
    counts_ccg_all,
    models,
    method = evaluate_aic,
    fixed_k = 7,
    alpha = 0.05
)

## ## For loop, useful to debug if specific ccgs fail
## for (i in 1:length(counts_ccg_all)) {
##   asmodee(counts_ccg_all[[i]],
##           models,
##           method = evaluate_aic,
##           fixed_k = 7,
##           alpha = 0.05)
## }

## derive summary stats
ccg_all_stats <- 
  summary(res_ccg_all) %>% 
  arrange()
ccg_all_stats <- summary(res_ccg_all)
ccg_all_stats$last_pred <- vapply(
  res_ccg_all, 
  function(x) tail(x$results$estimate, 1),
  double(1)
)
ccg_all_stats <- 
  rename(ccg_all_stats, ccg = group) %>% 
  arrange(ccg_all_stats, desc(n_recent_increases), desc(last_pred)) %>%
  tibble()

```



### Trend changes over the last week: overview

This graph provides an overview of the numbers of increases/decreases detected
at a CCG level by ASMODEE over the last week.

```{r ccg_outliers_summary, out_width = "50%"}

ccg_outliers_summary <- ccg_all_stats %>%
  mutate(n_recent_increases = factor(n_recent_increases, levels = 0:7),
         n_recent_decreases = factor(n_recent_decreases, levels = 0:7)) %>%
  group_by(n_recent_increases, n_recent_decreases) %>%
  count() %>%
  rename(increase = n_recent_increases,
         decrease = n_recent_decreases,
         frequency = n) %>%
  pivot_longer(1:2, names_to = "change", values_to = "n")

ccg_outliers_summary  %>%
  ggplot(aes(x = n, y = frequency, fill = change)) +
  geom_col(position = "dodge") +
  scale_fill_manual("Change over last week",
                    values = c(increase = "#B26363", decrease = "#93bca8")) +
  theme_bw() +
  labs(x = "Number of days showing trend change last week",
       y = "Number of CCGs",
       title = "Trend changes detected by ASMODEE") +
  theme(legend.position = "bottom")

```


```{r echo = FALSE}

n_figs <- length(res_ccg_all)

```

```{r reorder_ccg} 

## reorder ccgs
ccg_order <- ccg_all_stats %>%
  filter(ccg != "null") %>% 
  arrange(desc(n_recent_increases),
          desc(n_recent_outliers)) %>%
  pull(ccg)

oclass <- class(res_ccg_all)
res_ccg_all <- res_ccg_all[ccg_order]
names(res_ccg_all) <- sub("nhs_", "", names(res_ccg_all))
class(res_ccg_all) <- oclass
```


```{r ccg_map, echo = FALSE}
ccg_shape <- st_read(file.path("data", "shapefile", "ccg_2020.shp")) 

# create same matching names for ccg
ccg_shape_aligned <- ccg_shape %>%
  mutate(
    ccg = to_snake_case(ccg20nm),
    ccg = gsub("_ccg", "", ccg, fixed = TRUE),
    ccg = recode(ccg, "nhs_central_london_westminster" = "nhs_central_london_(westminster)") 
  ) 

# make plots
individual_plots <- lapply(res_ccg_all, plot, guide = FALSE)

CCG <- ccg_shape_aligned %>%
  full_join(., ccg_all_stats, by = "ccg") %>%
  filter(ccg != "null") %>% # there is a single ccg set as null I've removed it #
  select(ccg20nm, ccg, n_recent_outliers, n_recent_increases, n_recent_decreases, geometry) %>%
  mutate( # this should be able to join to the names in res_ccg_all
    n_recent_increases = factor(n_recent_increases),
    n_recent_decreases = factor(n_recent_decreases),
    ccg = gsub("nhs_", "", ccg, fixed = TRUE),
    plots = individual_plots[ccg]
  ) %>% 
  rename( # tidying the column titles for mapview
    `CCG Name` = ccg20nm,
    `Number of outlier days (last week)` = n_recent_outliers,
    `Days increased` = n_recent_increases,
    `Number of days decreased` = n_recent_decreases
  ) 
```



### CCGs with number of ASMODEE outlier days (increased) in the last week

Selecting the CCG will display the ASMODEE prediction plot for that CCG

``` {r combined, results="markup"}
CCG <- select(CCG, -ccg)
plots <- CCG$plots

mapviewOptions(leafletHeight = 620)
mapview(CCG, 
       zcol = "Days increased", 
       legend = T,
       alpha.regions = 1,
       lwd = 1.5,
       label = "CCG Name",
       popup = popupGraph(plots,
                          width = 260,
                          height = 180))
```



<!-- ### Map of case growth/decay in NHS regions -->

<!-- Selecting the region will display the ASMODEE prediction plot -->

<!-- ``` {r plot_regional,  results="markup"} -->
<!-- mapview(regions,  -->
<!--        zcol = "Case growth/decay",  -->
<!--        legend = T, -->
<!--        alpha.regions = 1, -->
<!--        lwd = 1.5, -->
<!--        label = "label", -->
<!--        col.regions = c("light blue", "grey", "dark red"), -->
<!--        popup = popupGraph(plots, -->
<!--                           width = 260, -->
<!--                           height = 180)) -->
<!-- ``` -->


<!-- ``` {r growth_ccg, echo = F} -->

<!-- rate_ccg <- counts_ccg_all %>%  -->
<!--   keep_last(7 * 4) %>%  -->
<!--   fit_curve("poisson") %>% # negbinomial removes several CCGs -->
<!--   growth_rate() %>% -->
<!--   mutate(time =  ifelse(time > 50, ">50 days", paste0(round(time, 0), " days"))) -->

<!-- ``` -->

<!-- growth_levels <- c("Halving" = "halving", "Minimal change" = "minimal change", "Doubling" = "doubling") -->

<!-- CCG <- ccg_shape_aligned %>% -->
<!--   full_join(., ccg_all_stats, by = "ccg") %>% -->
<!--   left_join(., rate_ccg %>% -->
<!--               rename("ccg" = "ccg_name") %>% -->
<!--               dplyr::select(ccg, growth_or_decay, time), -->
<!--             by = "ccg") %>% -->
<!--   filter(ccg != "null") %>% # there is a single ccg set as null I've removed it # -->
<!-- <<<<<<< HEAD -->
<!--   select(ccg20nm, ccg, n_outliers_recent, n_outliers, n_recent_increase, n_recent_decrease, geometry, growth_or_decay, time) %>% -->
<!--   mutate(n_recent_increase = factor(n_recent_increase), -->
<!--          n_recent_decrease = factor(n_recent_decrease), -->
<!--          growth = factor(ifelse(time >= 50, "minimal change", growth_or_decay), levels = c("halving", "minimal change", "doubling"), labels = names(growth_levels)), -->
<!--          growth = recode_factor(growth, !!!growth_levels), -->
<!--          label = paste0(`ccg20nm`, ", ", growth_or_decay, " time = ", time), -->
<!--          ccg = stringr::str_replace(ccg, "nhs_", ""), -->
<!--          plots = individual_plots[ccg]) %>% # this should be able to join to the names in res_ccg_all -->
<!--   rename("CCG Name" = "ccg20nm", -->
<!--          "Number of outlier days (last week)" = "n_outliers_recent", -->
<!--          "Number of outlier days (ever)" = "n_outliers", -->
<!--          "Days increased" = "n_recent_increase", -->
<!--          "Number of days decreased" = "n_recent_decrease") # tidying the column titles for mapview -->
<!-- ======= -->
<!--   select(ccg20nm, ccg, n_recent_outliers, n_recent_increases, n_recent_decreases, geometry) %>% -->
<!--   mutate( # this should be able to join to the names in res_ccg_all -->
<!--     n_recent_increases = factor(n_recent_increases), -->
<!--     n_recent_decreases = factor(n_recent_decreases), -->
<!--     ccg = gsub("nhs_", "", ccg, fixed = TRUE), -->
<!--     plots = individual_plots[ccg] -->
<!--   ) %>%  -->
<!--   rename( # tidying the column titles for mapview -->
<!--     `CCG Name` = ccg20nm, -->
<!--     `Number of outlier days (last week)` = n_recent_outliers, -->
<!--     `Days increased` = n_recent_increases, -->
<!--     `Number of days decreased` = n_recent_decreases -->
<!--   )  -->
<!-- >>>>>>> master -->
<!-- ``` -->



<!-- ### CCGs with number of ASMODEE outlier days (increased) in the last week -->

<!-- Selecting the CCG will display the ASMODEE prediction plot for that CCG -->

<!-- ``` {r combined, results="markup"} -->
<!-- <<<<<<< HEAD -->
<!-- CCG <- CCG %>% -->
<!--   select(-ccg) -->
<!-- plots <- CCG$plots -->

<!-- mapviewOptions(leafletHeight = 620, -->
<!--                basemaps = c("CartoDB.Positron")) -->

<!-- ======= -->
<!-- CCG <- select(CCG, -ccg) -->
<!-- plots <- CCG$plots -->

<!-- mapviewOptions(leafletHeight = 620) -->
<!-- >>>>>>> master -->
<!-- mapview(CCG,  -->
<!--        zcol = "Days increased",  -->
<!--        legend = T, -->
<!--        alpha.regions = 1, -->
<!--        lwd = 1.5, -->
<!--        label = "CCG Name", -->
<!--        popup = popupGraph(plots, -->
<!--                           width = 260, -->
<!--                           height = 180)) -->


<!-- ``` -->

<!-- <<<<<<< HEAD -->
<!-- ### CCGs with growth/decay of case numbers -->

<!-- ``` {r ccg_growth, results="markup"} -->
<!-- CCG <- CCG %>% -->
<!--           drop_na(growth) -->

<!-- mapview(CCG, -->
<!--         zcol = "growth", -->
<!--         na.color = "dark grey", -->
<!--         legend = T, -->
<!--         alpha.regions = 1, -->
<!--         lwd = 1.5, -->
<!--         label = "label", -->
<!--         col.regions = c("light blue", "grey", "dark red"), -->
<!--         popup = F) -->

<!-- growing <- CCG %>% -->
<!--   filter(growth == "doubling") %>% -->
<!--   tibble() %>% -->
<!--   select(`CCG Name`) %>% -->
<!--   as.vector()  -->
<!-- ``` -->

<!-- The CCGs with increasing growth are `r knitr::combine_words(growing)` -->

### CCG by numbers of outliers

The following graph shows ASMODEE results ordered by decreasing amounts of
outliers in the last 7 days.

```{r plots_all, eval = TRUE, fig.height = 2 * round(n_figs / 3), out.width = "100%", dpi = 50} 
# plot results for top ccg
plot(res_ccg_all, ncol = 3)

```

### Table summary for all CCGs

This table summarises the numbers of changes detected by ASMODEE over the last 7
days, broken down into increases and decreases. *prob* is the probability of
observing that many outliers in the last week under the best fitting model,
given the chosen alpha threshold (5%).

```{r ccg_all_table, results = "markup"}

# display table
ccg_all_stats %>%
  mutate(prob = format.pval(p_recent_outliers, digits = 3),
         ccg = gsub("_", " ", ccg),
         ccg = gsub("nhs", "NHS", ccg)) %>%
  select(ccg,
         changes = n_recent_outliers,
         increase = n_recent_increases,
         decrease = n_recent_decreases,
         prob) %>%
  DT::datatable(ccg_all_stats,
                rownames = FALSE,
                width = "100%",
                class = 'cell-border stripe',
                filter = 'top')

```


