---
title: "Covid-19 trends by CCG level"
description: |
  Using ASMODEE to monitor NHS pathways by CCG
author:
  - name: Thibaut Jombart, David Simons, Dirk Schumacher, Tim Taylor
date: "`r Sys.Date() - 1`"
output: distill::distill_article
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, results = "hide", fig.height = 5, fig.width = 8, dpi = 80)
```

Using the new algorithm ASMODEE (**A**utomatic **S**election of **M**odels and
**O**utlier **D**etection for **E**pidemics) we monitor changes in potential
COVID-19 cases reported through the [NHS
pathways](https://digital.nhs.uk/dashboards/nhs-pathways), including calls to
111, 999, and 111-online. These analyses are broken down by Clinical
Commissioning Groups [(CCG)](https://www.england.nhs.uk/ccgs/). Only the last 6
weeks of data are used. The last week of data is not used to define the temporal
trend so that recent outliers can be detected.

**Note**: this research has not been peer-reviewed yet. This website is still
experimental. Please contact the <a
href="mailto:thibautjombart@gmail.com">authors</a> before using its content.

* linear regression with a linear time effect
* Poisson GLMs
    + constant
    + with log-linear time effect
    + with log-linear time effect and weekend effect (weekend / monday / other
      day)
    + with log-linear time effect and weekday effect
* Negative Binomial GLMs
    + constant
    + with log-linear time effect
    + with log-linear time effect and weekend effect (weekend / monday / other
      day)
    + with log-linear time effect and weekday effect
	

Analyses are run separately for each CCG.

```{r packages}
library(incidence2)
library(trendbreaker)
library(ggplot2)
library(cowplot)
library(DT)
library(dplyr)
library(tibble)
library(tidyr)
library(forcats)
library(here)
library(sf)
library(mapview)
library(leaflet)
library(leafpop)
library(leafsync)
library(tmap)
library(stringr)
```

```{r prep}
# get the latest data
folder <- file.path("data", "clean")
filenames <- sort(list.files(folder), decreasing = TRUE)
pathways <- readRDS(file.path(folder, filenames[1]))

# tidy up names
pathways$ccg_name <- sub("_ccg$", "", pathways$ccg_name)
first_date <- max(pathways$date, na.rm = TRUE) - 7 * 7
pathways_recent <- pathways[pathways$date >= first_date, ]

# define candidate models
models <- list(
  regression = lm_model(count ~ date_index),
  poisson_constant = glm_model(count ~ 1, family = "poisson"),
  poisson_time = glm_model(count ~ date_index, family = "poisson"),
  poisson_time_daytype = glm_model(count ~ day_type + date_index, family = "poisson"),
  poisson_time_weekday = glm_model(count ~ weekday + date_index, family = "poisson"),
  negbin_constant = glm_nb_model(count ~ 1),
  negbin_time = glm_nb_model(count ~ date_index),
  negbin_time_daytype = glm_nb_model(count ~ day_type + date_index),
  negbin_time_weekday = glm_nb_model(count ~ weekday + date_index)
)

# function to assign custom day of the week to dates
day_of_week <- function(date) {
  day_of_week <- weekdays(date)
  out <- vapply(
    day_of_week,
    function(x) {
      if (x %in% c("Saturday", "Sunday")) {
        "Weekend"
      } else if (x == "Monday") {
        "Monday"
      } else {
        "rest_of_week"
      }
    },
    character(1)
  )
  factor(out, levels = c("rest_of_week", "Monday", "Weekend"))
}
``` 

## Results: 111/999 calls and 111-online.

These analyses use calls to 111 and 999, as well as NHS 111-online reports of
potential COVID-19 cases.

```{r results_ccg_calls}

# analyses by CCG

## get count by CCG
counts_ccg_all <- incidence(
  pathways_recent,
  date_index = date,
  count = count,
  groups = ccg_name
)

# add on day and weekday
counts_ccg_all <- counts_ccg_all %>%
  mutate(day_type = day_of_week(date_index),
         weekday = weekdays(date_index))



## run asmodee on all CCGs
## note: this takes about 1 minute to run with AIC model selection,
## around 16-17 min with cross validation
res_ccg_all <- asmodee(
    counts_ccg_all,
    models,
    method = evaluate_aic,
    fixed_k = 7,
    alpha = 0.05
)

## ## For loop, useful to debug if specific ccgs fail
## for (i in 1:length(counts_ccg_all)) {
##   asmodee(counts_ccg_all[[i]],
##           models,
##           method = evaluate_aic,
##           fixed_k = 7,
##           alpha = 0.05)
## }

## derive summary stats
ccg_all_stats <- res_ccg_all %>%
  lapply(function(e)
    data.frame(
      p_value = e$p_value,
      k = e$k,
      n_outliers_recent = e$n_outliers_recent,
      n_outliers = e$n_outliers,
      n_recent_increase = sum(tail(e$results$classification, 7) == "increase"),
      n_recent_decrease = sum(tail(e$results$classification, 7) == "decrease"),
      last_pred = tail(e$results$estimate, 1))
    ) %>%
  bind_rows(.id = "ccg") %>%
  arrange(desc(n_recent_increase),
          desc(last_pred)) %>%
  tibble()

```



### Trend changes over the last week: overview

This graph provides an overview of the numbers of increases/decreases detected
at a CCG level by ASMODEE over the last week.

```{r ccg_outliers_summary, out_width = "50%"}

ccg_outliers_summary <- ccg_all_stats %>%
  mutate(n_recent_increase = factor(n_recent_increase, levels = 0:7),
         n_recent_decrease = factor(n_recent_decrease, levels = 0:7)) %>%
  group_by(n_recent_increase, n_recent_decrease) %>%
  count() %>%
  rename(increase = n_recent_increase,
         decrease = n_recent_decrease,
         frequency = n) %>%
  pivot_longer(1:2, names_to = "change", values_to = "n")

ccg_outliers_summary  %>%
  ggplot(aes(x = n, y = frequency, fill = change)) +
  geom_col(position = "dodge") +
  scale_fill_manual("Change over last week",
                    values = c(increase = "#B26363", decrease = "#93bca8")) +
  theme_bw() +
  labs(x = "Number of days showing trend change last week",
       y = "Number of CCGs",
       title = "Trend changes detected by ASMODEE") +
  theme(legend.position = "bottom")

```


```{r echo = FALSE}

n_figs <- length(res_ccg_all)

```

```{r reorder_ccg} 

## reorder ccgs
ccg_order <- ccg_all_stats %>%
  filter(ccg != "null") %>% 
  arrange(desc(n_recent_increase),
          desc(n_outliers_recent)) %>%
  pull(ccg)

oclass <- class(res_ccg_all)
res_ccg_all <- res_ccg_all[ccg_order]
names(res_ccg_all) <- sub("nhs_", "", names(res_ccg_all))
class(res_ccg_all) <- oclass
```


```{r ccg_map, echo = FALSE}
ccg_shape <- st_read(here("data", "shapefile", "ccg_2020.shp")) 

ccg_shape_aligned <- ccg_shape %>%
  mutate(ccg = snakecase::to_snake_case(ccg_shape$ccg20nm) %>%
           stringr::str_replace(., "_ccg", ""),
         ccg = recode(ccg, 
                      "nhs_central_london_westminster" = "nhs_central_london_(westminster)")) # same name structure as your df #

individual_plots <- lapply(res_ccg_all, plot, guide = F)

CCG <- ccg_shape_aligned %>%
  full_join(., ccg_all_stats, by = "ccg") %>%
  filter(ccg != "null") %>% # there is a single ccg set as null I've removed it #
  select(ccg20nm, ccg, n_outliers_recent, n_outliers, n_recent_increase, n_recent_decrease, geometry) %>%
  mutate(n_recent_increase = factor(n_recent_increase),
         n_recent_decrease = factor(n_recent_decrease),
         ccg = stringr::str_replace(ccg, "nhs_", ""),
         plots = individual_plots[ccg]) %>% # this should be able to join to the names in res_ccg_all
  rename("CCG Name" = "ccg20nm",
         "Number of outlier days (last week)" = "n_outliers_recent",
         "Number of outlier days (ever)" = "n_outliers",
         "Days increased" = "n_recent_increase",
         "Number of days decreased" = "n_recent_decrease") # tidying the column titles for mapview
```



### CCGs with number of ASMODEE outlier days (increased) in the last week

Selecting the CCG will display the ASMODEE prediction plot for that CCG

``` {r combined, results="markup"}
CCG <- CCG %>%
  select(-ccg)

mapviewOptions(leafletHeight = 620)

mapview(CCG, 
       zcol = "Days increased", 
       legend = T,
       alpha.regions = 1,
       lwd = 1.5,
       label = "CCG Name",
       popup = popupGraph(CCG$plots,
                          width = 260,
                          height = 180))
```

``` {r regional_maps}
# Keeping this in for now but I'll panel the tmap plots for regional snapshots

# increased <- tm_shape(CCG) +
#   tm_polygons(col = "Number of days increased", palette = "viridis",
#               legend.hist = T) +
#   tm_layout(main.title = "Number of days in the last week with outliers (increased)",
#             main.title.size = 0.9,
#             legend.outside = T,
#             legend.outside.position = "bottom")
# 
# decreased <- tm_shape(CCG) +
#   tm_polygons(col = "Number of days decreased", palette = "viridis",
#               legend.hist = T) +
#   tm_layout(main.title = "Number of days in the last week with outliers (decreased)",
#             main.title.size = 0.9,
#             legend.outside = T,
#             legend.outside.position = "bottom")
# 
# tmap_arrange(increased, decreased) 

```

### CCG by numbers of outliers

The following graph shows ASMODEE results ordered by decreasing amounts of
outliers in the last 7 days.

```{r plots_all, eval = TRUE, fig.height = 2 * round(n_figs / 3), out.width = "100%", dpi = 50} 
# plot results for top ccg
plot(res_ccg_all, ncol = 3)

```

### Table summary for all CCGs

This table summarises the numbers of changes detected by ASMODEE over the last 7
days, broken down into increases and decreases. *prob* is the probability of
observing that many outliers in the last week under the best fitting model,
given the chosen alpha threshold (5%).

```{r ccg_all_table, results = "markup"}

# display table
ccg_all_stats %>%
  mutate(prob = format.pval(p_value, digits = 3),
         ccg = gsub("_", " ", ccg),
         ccg = gsub("nhs", "NHS", ccg)) %>%
  select(ccg,
         changes = n_outliers_recent,
         increase = n_recent_increase,
         decrease = n_recent_decrease,
         p_value) %>%
  DT::datatable(ccg_all_stats,
                rownames = FALSE,
                width = "100%",
                class = 'cell-border stripe',
                filter = 'top')

```


