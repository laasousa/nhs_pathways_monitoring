---
title: "COVID-19 trends in England"
author: "Thibaut Jombart, Dirk Schumacher"
date: "`r Sys.Date() - 1`"
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      results = "hide",
                      collapse = TRUE,
                      dpi = 80,
                      fig.height = 5,
                      fig.width = 8,
                      out.width = "100%",
                      warning = FALSE,
                      message = FALSE,
                      dev = "png")
```

Using the new algorithm ASMODEE (**A**utomatic **S**election of **M**odels and
**O**utlier **D**etection for **E**pidemics) we monitor changes in potential
COVID-19 cases reported through the [NHS
pathways](https://digital.nhs.uk/dashboards/nhs-pathways), including calls to
111, 999, and 111-online. Only the last 6 weeks of data are used.

**Note**: this research has not been peer-reviewed yet. This website is still
experimental. Please contact the <a
href="mailto:thibautjombart@gmail.com">authors</a> before using its content.


Models considered here for trend fitting include:

1. linear regression of counts over time

2. Poisson GLM with a constant rate

3. Negative Binomial GLM with a log-linear effect of time

4. Negative Binomial GLM with a log-linear effect of time and a 'weekday' effect
distinguishing weekends, Mondays, and the rest of the week

5. As 4), but with an interaction between time and weekday


Analyses are run separately for each NHS region.

```{r installs}

Sys.setenv(R_REMOTES_NO_ERRORS_FROM_WARNINGS = "true", eval = FALSE)
repo <- "https://cloud.r-project.org/"

if(!require(tidyverse)) {
  install.packages("tidyverse", repos = "https://cloud.r-project.org/")
  library(tidyverse)
}

if(!require(remotes)) {
  install.packages("devtools", repos = "https://cloud.r-project.org/")
  library(devtools)
}

if(!require(DT)) {
  install.packages("DT", repos = "https://cloud.r-project.org/")
  library(DT)
}

remotes::install_github("reconhub/trendbreaker", upgrade = FALSE)
library(trendbreaker)

```



```{r prepare_data}

# download data
pathways <- tempfile()
download.file("https://github.com/qleclerc/nhs_pathways_report/raw/master/data/rds/pathways_latest.rds", pathways)
pathways <- readRDS(pathways)


# add variables and subsets
day_of_week <- function(date) {
  day_of_week <- weekdays(date)
  out <- dplyr::case_when(
    day_of_week %in% c("Saturday", "Sunday") ~ "weekend",
    day_of_week %in% c("Monday") ~ "monday",
    TRUE ~ "rest_of_week"
  )
  out <- factor(out, levels = c("rest_of_week", "monday", "weekend"))
  out
}

pathways <- as_tibble(pathways) %>%
  mutate(nhs_region = str_to_title(gsub("_", " ", nhs_region)),
         nhs_region = gsub(" Of ", " of ", nhs_region),
         nhs_region = gsub(" And ", " and ", nhs_region),
         day = as.integer(date - min(date, na.rm = TRUE)),
         weekday = day_of_week(date),
         ccg_name = sub("_ccg$", "", ccg_name))

first_date <- max(pathways$date, na.rm = TRUE) - 6*7
pathways_recent <- pathways %>%
  filter(date >= first_date)



# define candidate models
models <- list(
  regression = lm_model(count ~ day),
  poisson_constant = glm_model(count ~ 1, family = "poisson"),
  negbin_time = glm_nb_model(count ~ day),
  negbin_time_weekday = glm_nb_model(count ~ day + weekday),
  negbin_time_weekday2 = glm_nb_model(count ~ day * weekday)
  )


```



## England

```{r results_england, out.width = "85%"}

# analyses on all data
counts_england <- pathways_recent %>%
  group_by(date, day, weekday) %>%
  summarise(count = sum(count))


## results with automated detection of 'k'
res_england <- asmodee(counts_england, models, method = evaluate_aic)
plot(res_england, "date") +
  theme(text = element_text(size = 16),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_date(date_label = format("%d %b")) +
  labs(x = NULL,
       y = "Daily potential COVID-19 reports\nin NHS pathways")

```



## NHS regions

```{r results_nhs_region, fig.height = 7}

counts_nhs_region <- pathways_recent %>%
  group_by(nhs_region, date, day, weekday) %>%
  summarise(count = sum(count)) %>%
  complete(date, fill = list(count = 0)) %>% 
  split(.$nhs_region)

res_nhs_region <- lapply(counts_nhs_region,
                         asmodee,
                         models,
                         method = evaluate_aic,
                         alpha = 0.05)

plots_nhs_region <- lapply(seq_along(res_nhs_region),
                           function(i)
                             plot(res_nhs_region[[i]], "date", point_size = 1, guide = FALSE) +
                               theme(text = element_text(size = 12),
                                     axis.text.x = element_text(angle = 45, hjust = 1)) +
                               scale_x_date(date_label = format("%d %b")) +
                               labs(x = NULL,
                                    y = NULL,
                                    subtitle = names(res_nhs_region)[i]))

cowplot::plot_grid(plotlist = plots_nhs_region)

```

